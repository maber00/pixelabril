---
// src/layouts/Layout.astro - VERSI√ìN CORREGIDA SIN ERRORES

import '../styles/global.css';
import Footer from '../components/Footer.astro';
import Header from '../components/Header.astro';

export interface Props {
	title: string;
	description?: string;
	ogImage?: string;
	canonical?: string;
	noindex?: boolean;
	structuredData?: object;
}

const { 
	title, 
	description = "Pixel Living es coliving en Bogot√° para quienes buscan algo m√°s que un arriendo. Apartaestudios dise√±ados para estad√≠as medianas y largas, con estilo, comodidad y comunidad.", 
	ogImage = "/images/pixel-living-og.jpg",
	canonical,
	noindex = false,
	structuredData = null
} = Astro.props;

const pathname = Astro.url.pathname;
const siteUrl = "https://pixelliving.co";
const canonicalUrl = canonical || `${siteUrl}${pathname}`;

// Structured data por defecto
const defaultStructuredData = {
	"@context": "https://schema.org",
	"@graph": [
		{
			"@type": "Organization",
			"@id": `${siteUrl}/#organization`,
			"name": "Pixel Living",
			"url": siteUrl,
			"logo": {
				"@type": "ImageObject",
				"@id": `${siteUrl}/#logo`,
				"url": `${siteUrl}/images/logo-pixel-living.webp`,
				"width": 300,
				"height": 100
			},
			"contactPoint": {
				"@type": "ContactPoint",
				"telephone": "+57-301-787-2595",
				"contactType": "customer service",
				"availableLanguage": "Spanish"
			},
			"address": {
				"@type": "PostalAddress",
				"addressLocality": "Bogot√°",
				"addressCountry": "CO"
			},
			"sameAs": [
				"https://instagram.com/pixelliving",
				"https://facebook.com/pixelliving"
			]
		},
		{
			"@type": "WebSite",
			"@id": `${siteUrl}/#website`,
			"url": siteUrl,
			"name": "Pixel Living",
			"description": description,
			"publisher": {
				"@id": `${siteUrl}/#organization`
			},
			"potentialAction": [
				{
					"@type": "SearchAction",
					"target": {
						"@type": "EntryPoint",
						"urlTemplate": `${siteUrl}/buscar?q={search_term_string}`
					},
					"query-input": "required name=search_term_string"
				}
			]
		},
		{
			"@type": "Service",
			"@id": `${siteUrl}/#service`,
			"name": "Coliving Pixel Living",
			"description": "Servicio de coliving premium en Bogot√° con apartaestudios completamente amoblados",
			"provider": {
				"@id": `${siteUrl}/#organization`
			},
			"areaServed": {
				"@type": "City",
				"name": "Bogot√°"
			},
			"serviceType": "Coliving",
			"category": "Accommodation"
		}
	]
};

const finalStructuredData = structuredData || defaultStructuredData;
---

<!DOCTYPE html>
<html lang="es" dir="ltr">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		
		<!-- üöÄ PRECONNECT HINTS CR√çTICOS - Solo dominios necesarios -->
		<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
		
		<!-- üåê DNS PREFETCH para recursos secundarios -->
		<link rel="dns-prefetch" href="https://maps.googleapis.com">
		<link rel="dns-prefetch" href="https://formsubmit.co">
		<link rel="dns-prefetch" href="https://wa.me">
		
		<!-- üì± Favicon y iconos - Solo los que existen -->
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
		<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
		<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
		<!-- Removido manifest hasta que exista el archivo -->
		<meta name="theme-color" content="#009185" />
		<meta name="msapplication-TileColor" content="#009185" />
		
		<!-- üìã Meta tags b√°sicos -->
		<meta name="generator" content={Astro.generator} />
		<meta name="author" content="Pixel Living" />
		<meta name="robots" content={noindex ? "noindex, nofollow" : "index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"} />
		
		<!-- üîó Canonical URL -->
		<link rel="canonical" href={canonicalUrl} />
		
		<!-- üè∑Ô∏è Primary Meta Tags -->
		<title>{title}</title>
		<meta name="title" content={title} />
		<meta name="description" content={description} />
		<meta name="keywords" content="coliving Bogot√°, apartaestudios amoblados, hospedaje temporal, vivienda temporal, pixel living, comunidad digital, coworking" />
		
		<!-- üìä Open Graph / Facebook -->
		<meta property="og:type" content="website" />
		<meta property="og:site_name" content="Pixel Living" />
		<meta property="og:url" content={canonicalUrl} />
		<meta property="og:title" content={title} />
		<meta property="og:description" content={description} />
		<meta property="og:image" content={`${siteUrl}${ogImage}`} />
		<meta property="og:image:alt" content="Pixel Living - Coliving en Bogot√°" />
		<meta property="og:image:width" content="1200" />
		<meta property="og:image:height" content="630" />
		<meta property="og:locale" content="es_CO" />
		
		<!-- üê¶ Twitter -->
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@pixelliving" />
		<meta name="twitter:creator" content="@pixelliving" />
		<meta name="twitter:url" content={canonicalUrl} />
		<meta name="twitter:title" content={title} />
		<meta name="twitter:description" content={description} />
		<meta name="twitter:image" content={`${siteUrl}${ogImage}`} />
		<meta name="twitter:image:alt" content="Pixel Living - Coliving en Bogot√°" />
		
		<!-- üìç Geo tags para ubicaci√≥n -->
		<meta name="geo.region" content="CO-DC" />
		<meta name="geo.placename" content="Bogot√°" />
		<meta name="geo.position" content="4.7110;-74.0721" />
		<meta name="ICBM" content="4.7110, -74.0721" />
		
		<!-- ‚ö° PRELOAD RECURSOS CR√çTICOS - Solo los que existen -->
		<link rel="preload" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
		<link rel="preload" href="https://fonts.googleapis.com/css2?family=Cal+Sans:wght@400;500;600&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
		
		<!-- NOSCRIPT FALLBACK para fuentes -->
		<noscript>
			<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
			<link href="https://fonts.googleapis.com/css2?family=Cal+Sans:wght@400;500;600&display=swap" rel="stylesheet">
		</noscript>
		
		<!-- üéØ CRITICAL CSS INLINE - Optimizado -->
		<style>
			/* Critical CSS para evitar FOUC y mejorar LCP */
			html { 
				scroll-behavior: smooth; 
				font-display: swap; 
			}
			
			body { 
				font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
				margin: 0;
				padding: 0;
				background: white;
				color: #1f2937;
				line-height: 1.6;
			}
			
			/* Header critical styles */
			header {
				position: fixed;
				top: 0;
				width: 100%;
				z-index: 50;
				background: rgba(255, 255, 255, 0.95);
				backdrop-filter: blur(10px);
			}
			
			/* ‚ôø Skip links MEJORADOS para accesibilidad */
			.skip-links { 
				position: fixed; 
				top: 0; 
				left: 0; 
				z-index: 9999; 
			}
			
			.skip-link {
				position: absolute;
				top: -40px;
				left: 6px;
				background: #000;
				color: #fff;
				padding: 8px 12px;
				text-decoration: none;
				border-radius: 0 0 4px 0;
				transform: translateY(-100%);
				transition: transform 0.3s ease;
				font-size: 14px;
				font-weight: 500;
			}
			
			.skip-link:focus {
				transform: translateY(0);
				outline: 2px solid #ffd700;
				outline-offset: 2px;
			}
			
			/* Prevent FOUC y layout shift */
			.main-content { 
				min-height: 50vh; 
			}
			
			/* Optimizaci√≥n de im√°genes */
			img { 
				height: auto; 
				max-width: 100%; 
			}
			
			/* üî• ESTILOS CR√çTICOS PARA FORMULARIOS */
			.field-neutral { 
				border-color: #d1d5db; 
			}
			.field-valid { 
				border-color: #059669 !important; 
				box-shadow: 0 0 0 1px #059669 !important;
				background-color: rgba(5, 150, 105, 0.05) !important;
			}
			.field-invalid { 
				border-color: #dc2626 !important; 
				box-shadow: 0 0 0 1px #dc2626 !important;
				background-color: rgba(220, 38, 38, 0.05) !important;
			}
			.form-loading { 
				pointer-events: none; 
				opacity: 0.8; 
			}
			
			/* Validaci√≥n feedback */
			.pixel-validation-container {
				margin-top: 0.5rem;
				min-height: 1.5rem;
			}
			
			.validation-feedback {
				display: flex;
				align-items: center;
				gap: 0.5rem;
				font-size: 0.875rem;
				transition: all 0.2s ease;
			}
			.validation-feedback.validation-valid { color: #059669; }
			.validation-feedback.validation-invalid { color: #dc2626; }
			
			/* Contador de caracteres */
			.character-counter {
				margin-top: 0.25rem;
				font-size: 0.75rem;
				transition: color 0.2s ease;
			}
			.character-counter.counter-normal { color: #6b7280; }
			.character-counter.counter-warning { color: #d97706; font-weight: 600; }
			.character-counter.counter-error { color: #dc2626; font-weight: 600; }
			
			/* Notificaciones */
			.pixel-notification {
				position: fixed;
				top: 20px;
				right: 20px;
				z-index: 9999;
				max-width: 400px;
				padding: 1rem 1.5rem;
				border-radius: 0.5rem;
				color: white;
				font-weight: 500;
				box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
				transform: translateX(100%);
				transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
			}
			.pixel-notification.show { transform: translateX(0); }
			.pixel-notification.notification-success { background: linear-gradient(135deg, #22c55e, #16a34a); }
			.pixel-notification.notification-error { background: linear-gradient(135deg, #ef4444, #dc2626); }
			
			/* Screen reader only utility */
			.sr-only {
				position: absolute;
				width: 1px;
				height: 1px;
				padding: 0;
				margin: -1px;
				overflow: hidden;
				clip: rect(0, 0, 0, 0);
				white-space: nowrap;
				border: 0;
			}
			
			/* Responsive optimizations */
			@media (max-width: 768px) {
				.pixel-notification {
					top: 10px;
					right: 10px;
					left: 10px;
					max-width: none;
					transform: translateY(-100%);
				}
				
				.pixel-notification.show {
					transform: translateY(0);
				}
				
				.skip-link {
					padding: 6px 10px;
					font-size: 13px;
				}
			}
		</style>
		
		<!-- üìä Structured Data -->
		<script type="application/ld+json" set:html={JSON.stringify(finalStructuredData)}></script>
		
		<!-- ‚ö° Performance hints -->
		<meta http-equiv="x-dns-prefetch-control" content="on" />
		
		<!-- üåê Alternativas de idioma -->
		<link rel="alternate" hreflang="es" href={canonicalUrl} />
		<link rel="alternate" hreflang="es-CO" href={canonicalUrl} />
		<link rel="alternate" hreflang="x-default" href={canonicalUrl} />
	</head>
	
	<body class="font-poppins text-gray-800 bg-white">
		<!-- ‚ôø Skip Links MEJORADOS para accesibilidad -->
		<div class="skip-links" role="navigation" aria-label="Enlaces de acceso r√°pido">
			<a href="#main-content" class="skip-link">
				Saltar al contenido principal
			</a>
			<a href="#navigation" class="skip-link">
				Saltar al men√∫ de navegaci√≥n
			</a>
			<a href="#espacios" class="skip-link">
				Saltar a apartaestudios
			</a>
			<a href="#reservas" class="skip-link">
				Saltar al formulario de reservas
			</a>
			<a href="#footer" class="skip-link">
				Saltar al pie de p√°gina
			</a>
		</div>
		
		<!-- üéØ Header -->
		<Header />
		
		<!-- üìÑ Main content wrapper -->
		<main id="main-content" class="main-content" role="main">
			<slot />
		</main>
		
		<!-- ü¶∂ Footer -->
		<Footer />
		
		<!-- üì¢ Live region para anuncios de screen reader -->
		<div id="live-region" aria-live="polite" aria-atomic="true" class="sr-only"></div>
		
		<!-- üöÄ INICIALIZACI√ìN SIMPLIFICADA Y SEGURA -->
		<script is:inline>
			// Inicializaci√≥n con error handling robusto
			document.addEventListener('DOMContentLoaded', () => {
				const initStart = performance.now();
				
				try {
					console.log('‚úÖ Pixel Living: Iniciando sistema...');
					
					// Verificar elementos b√°sicos
					const forms = document.querySelectorAll('form');
					const images = document.querySelectorAll('img');
					const buttons = document.querySelectorAll('button');
					
					console.log('üìä Elementos encontrados:', {
						formularios: forms.length,
						im√°genes: images.length,
						botones: buttons.length
					});
					
					// Verificar si existe el sistema de formularios
					if (typeof window.PIXEL_FORM_UNIFIED_LOADED !== 'undefined' && window.PIXEL_FORM_UNIFIED_LOADED) {
						console.log('‚úÖ Sistema de formularios cargado');
						
						// Test contador de caracteres si existe
						const textarea = document.querySelector('textarea');
						if (textarea && window.PIXEL_FORM_UNIFIED && window.PIXEL_FORM_UNIFIED.updateCharacterCounter) {
							window.PIXEL_FORM_UNIFIED.updateCharacterCounter(textarea);
						}
					} else {
						console.log('‚ÑπÔ∏è Sistema de formularios no disponible (normal en algunas p√°ginas)');
					}
					
					const initTime = Math.round(performance.now() - initStart);
					console.log(`‚úÖ Pixel Living: Sistema inicializado en ${initTime}ms`);
					
				} catch (error) {
					console.error('‚ùå Error en inicializaci√≥n:', error);
				}
			});
			
			// Mejorar skip links con indicador visual
			try {
				document.querySelectorAll('.skip-link').forEach(link => {
					link.addEventListener('focus', function() {
						document.body.classList.add('skip-link-focused');
					});
					
					link.addEventListener('blur', function() {
						document.body.classList.remove('skip-link-focused');
					});
				});
			} catch (error) {
				console.warn('‚ö†Ô∏è Error configurando skip links:', error);
			}
		</script>
		
		<!-- üõ°Ô∏è Error boundary global MEJORADO -->
		<script is:inline>
			// Global error handler mejorado
			window.addEventListener('error', (e) => {
				console.error('Global error:', {
					message: e.message,
					filename: e.filename,
					line: e.lineno,
					column: e.colno,
					error: e.error
				});
			});
			
			window.addEventListener('unhandledrejection', (e) => {
				console.error('Unhandled promise rejection:', e.reason);
			});
		</script>
	</body>
</html>

<!-- üé® ESTILOS ADICIONALES -->
<style>
	/* Focus management mejorado */
	.keyboard-navigation *:focus,
	*:focus-visible {
		outline: 2px solid #ffd700;
		outline-offset: 2px;
		box-shadow: 0 0 0 4px rgba(255, 215, 0, 0.3);
	}
	
	/* Custom scrollbar */
	::-webkit-scrollbar {
		width: 8px;
	}
	
	::-webkit-scrollbar-track {
		background: #f1f1f1;
	}
	
	::-webkit-scrollbar-thumb {
		background: #c1c1c1;
		border-radius: 4px;
	}
	
	::-webkit-scrollbar-thumb:hover {
		background: #a1a1a1;
	}
	
	/* Selection styling */
	::selection {
		background-color: #ffd700;
		color: #000;
	}
	
	::-moz-selection {
		background-color: #ffd700;
		color: #000;
	}
	
	/* üñ®Ô∏è Print styles */
	@media print {
		.skip-links,
		header,
		footer,
		.lightbox-modal,
		.pixel-spinner,
		.notification {
			display: none !important;
		}
		
		body {
			font-size: 12pt;
			line-height: 1.4;
			color: black;
			background: white;
		}
		
		h1, h2, h3, h4, h5, h6 {
			page-break-after: avoid;
		}
		
		img {
			max-width: 100% !important;
			height: auto !important;
		}
	}
	
	/* üé≠ Animations con respeto a prefers-reduced-motion */
	@media (prefers-reduced-motion: reduce) {
		*,
		*::before,
		*::after {
			animation-duration: 0.01ms !important;
			animation-iteration-count: 1 !important;
			transition-duration: 0.01ms !important;
		}
		
		.skip-link {
			transition: none;
		}
	}
</style>