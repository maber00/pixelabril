---
// Importar el componente LightboxModal
import LightboxModal from '../components/LightboxModal.astro';

import iconoCama from '../assets/icoos_24-Breakfast.svg'; 
import iconoCocina from '../assets/icoos_17-Key card.svg';
import iconoEscritorio from '../assets/icoos_23-Bell.svg';
import iconoWifi from '../assets/icoos_18-Key.svg';
import iconoServicios from '../assets/icoos_22-Air condition.svg';
import iconoPrivado from '../assets/icoos_16-Bed.svg';

// Definici√≥n de tipos
interface Estudio {
  id: string;
  nombre: string;
  color: string;
  imagen: string;
  descripcion: string;
  metros: string;
  precio: string;
  galeria: string[];
  caracteristicas: string[];
  incluye: string[];
}

interface EstudiosRecord {
  [key: string]: Estudio;
}

// Estudios completos con datos reales del proyecto
const estudiosCompletos: EstudiosRecord = {
  'jade': {
    id: 'jade',
    nombre: 'Estudio Jade',
    color: 'bg-green-500',
    imagen: '/images/estudios/jade/pixel-jade-room-004.webp',
    descripcion: 'Espacio luminoso con toques de verde que evocan naturaleza y tranquilidad.',
    metros: '28m¬≤',
    precio: 'Desde $1.800.000',
    galeria: [ 
      '/images/estudios/jade/pixel-jade-room-005.webp', 
      '/images/estudios/jade/pixel-jade-room-001.webp',  
      '/images/estudios/jade/pixel-jade-room-002.webp',   
      '/images/estudios/jade/pixel-jade-room-006.webp',
      '/images/estudios/jade/pixel-jade-room-007.webp',
      '/images/estudios/jade/pixel-jade-room-008.webp'
    ],
    caracteristicas: [
      'Cama doble con colch√≥n ortop√©dico',
      'Escritorio amplio con silla ergon√≥mica',
      'Kitchenette equipada',
      'Ba√±o privado con ducha',
      'Armario empotrado',
      'Iluminaci√≥n LED regulable'
    ],
    incluye: [
      'Wifi de alta velocidad',
      'Servicios b√°sicos (agua, luz, gas)',
      'Limpieza quincenal',
      'Acceso a zonas comunes',
      'Smart TV con Netflix',
      'Ropa de cama y toallas'
    ]
  },
  'zian': {
    id: 'zian',
    nombre: 'Estudio Zian',
    color: 'bg-blue-500',
    imagen: '/images/estudios/zian/pixel-zian-room-008.webp',
    descripcion: 'Colores azules que transmiten calma y concentraci√≥n, ideal para trabajo remoto.',
    metros: '32m¬≤',
    precio: 'Desde $2.100.000',
    galeria: [
      '/images/estudios/zian/pixel-zian-room-001.webp', 
      '/images/estudios/zian/pixel-zian-room-002.webp', 
      '/images/estudios/zian/pixel-zian-room-003.webp', 
      '/images/estudios/zian/pixel-zian-room-004.webp', 
      '/images/estudios/zian/pixel-zian-room-005.webp',
      '/images/estudios/zian/pixel-zian-room-006.webp', 
      '/images/estudios/zian/pixel-zian-room-007.webp', 
      '/images/estudios/zian/pixel-zian-room-009.webp', 
      '/images/estudios/zian/pixel-zian-room-010.webp' 
    ],
    caracteristicas: [
      'Cama doble premium con almacenamiento',
      'Estaci√≥n de trabajo completa',
      'Cocina equipada con microondas',
      'Ba√±o con ducha de lluvia',
      'Closet con organizaci√≥n modular',
      'Sistema de sonido bluetooth'
    ],
    incluye: [
      'Wifi de alta velocidad (200 Mbps)',
      'Servicios b√°sicos premium',
      'Limpieza semanal',
      'Acceso completo a coworking',
      'Smart TV 43" con apps de streaming',
      'Amenities premium de ba√±o'
    ]
  },
  'indigo': {
    id: 'indigo',
    nombre: 'Estudio √çndigo',
    color: 'bg-indigo-500',
    imagen: '/images/estudios/indigo/pixel-indigo-room-005.webp',
    descripcion: 'Tonos violetas que inspiran creatividad y reflexi√≥n en un ambiente acogedor.',
    metros: '35m¬≤',
    precio: 'Desde $2.300.000',
    galeria: [
      '/images/estudios/indigo/pixel-indigo-room-001.webp', 
      '/images/estudios/indigo/pixel-indigo-room-002.webp', 
      '/images/estudios/indigo/pixel-indigo-room-003.webp', 
      '/images/estudios/indigo/pixel-indigo-room-004.webp', 
      '/images/estudios/indigo/pixel-indigo-room-006.webp',
      '/images/estudios/indigo/pixel-indigo-room-007.webp', 
      '/images/estudios/indigo/pixel-indigo-room-008.webp', 
      '/images/estudios/indigo/pixel-indigo-room-009.webp', 
      '/images/estudios/indigo/pixel-indigo-room-010.webp',
      '/images/estudios/indigo/pixel-indigo-room-011.webp', 
      '/images/estudios/indigo/pixel-indigo-room-012.webp', 
      '/images/estudios/indigo/pixel-indigo-room-013.webp', 
      '/images/estudios/indigo/pixel-indigo-room-014.webp', 
      '/images/estudios/indigo/pixel-indigo-room-016.webp', 
      '/images/estudios/indigo/pixel-indigo-room-017.webp', 
      '/images/estudios/indigo/pixel-indigo-room-018.webp'
    ],
    caracteristicas: [
      'Cama queen con colch√≥n premium',
      '√Årea de trabajo separada',
      'Cocina completa con barra desayunador',
      'Ba√±o completo con amenities',
      'Walk-in closet',
      'Zona de estar con sof√°'
    ],
    incluye: [
      'Wifi dedicado de alta velocidad',
      'Servicios b√°sicos premium',
      'Limpieza semanal con cambio de s√°banas',
      'Acceso premium a todas las √°reas comunes',
      'Smart TV 50" con todas las plataformas',
      'Caja de seguridad digital'
    ]
  }
};

// Cambiar la interfaz Caracteristica
interface Caracteristica {
  icono: ImageMetadata;
  texto: string;
}

// REEMPLAZAR el array caracteristicas por esto:
const caracteristicas: Caracteristica[] = [
  {
    icono: iconoCama,
    texto: 'Cama doble'
  },
  {
    icono: iconoCocina,
    texto: 'Cocina equipada'
  },
  {
    icono: iconoEscritorio,
    texto: 'Escritorio de trabajo'
  },
  {
    icono: iconoWifi,
    texto: 'WiFi de alta velocidad'
  },
  {
    icono: iconoServicios,
    texto: 'Servicios incluidos'
  },
  {
    icono: iconoPrivado,
    texto: 'Espacio privado y tranquilo'
  }
];

// Derivar arrays simplificados
interface EstudioSimplificado {
  id: string;
  nombre: string;
  color: string;
  imagen: string;
  descripcion: string;
  metros: string;
  precio: string;
}

interface LightboxEstudio {
  nombre: string;
  imagenPrincipal: string;
  imagenes: string[];
  color: string;
}

interface LightboxData {
  [key: string]: LightboxEstudio;
}

const estudios: EstudioSimplificado[] = Object.values(estudiosCompletos).map(estudio => ({
  id: estudio.id,
  nombre: estudio.nombre,
  color: estudio.color,
  imagen: estudio.imagen,
  descripcion: estudio.descripcion,
  metros: estudio.metros,
  precio: estudio.precio
}));

const lightboxData: LightboxData = Object.values(estudiosCompletos).reduce((result, estudio) => {
  result[estudio.id] = {
    nombre: estudio.nombre,
    imagenPrincipal: estudio.imagen,
    imagenes: estudio.galeria,
    color: estudio.color
  };
  return result;
}, {} as LightboxData);
---

<section id="espacios" class="section bg-pixel-blue/5" role="region" aria-labelledby="espacios-heading">
  <div class="container">
    <div class="text-center bg-pixel-blue rounded-t-2xl">
      <span class="inline-block text-pixel-blue font-semibold text-sm uppercase tracking-wider mb-2">Nuestros espacios</span>
      <h2 id="espacios-heading" class="text-4xl md:text-7xl font-normal px-4 md:px-18">
        Espacios dise√±ados para vivir con <span class="text-blue-100">intenci√≥n</span>
      </h2>
      
      <p class="text-lg text-blue-100 max-w-5xl pb-10 px-4 mx-auto mt-6">
        Cada uno de nuestros apartaestudios est√° completamente amoblado y listo para recibirte.
        Con dise√±o moderno, luz natural y todo lo necesario para que te sientas en casa desde el primer d√≠a.
      </p>
    </div>
    
    <!-- Carrusel de apartaestudios - ESTRUCTURA CORREGIDA -->
    <div class="bg-pixel-blue">
      <!-- Contenedor del carrusel con padding interno -->
      <div class="relative max-w-7xl mx-auto" id="carousel-container">
        
        <!-- √Årea de contenido con padding para los botones -->
        <div class="px-4 md:px-16 py-8 relative overflow-hidden">
          
          <!-- Instrucciones para lectores de pantalla -->
          <div class="sr-only" id="carousel-instructions">
            Use las flechas izquierda y derecha para navegar, o presione Tab para explorar cada estudio individualmente.
          </div>
          
          <!-- Botones de navegaci√≥n - POSICIONADOS CORRECTAMENTE -->
          <button 
            class="absolute left-2 top-1/2 z-10 -translate-y-1/2 bg-white rounded-lg p-3 shadow-lg hover:bg-gray-100 focus:outline-none disabled:opacity-30 disabled:cursor-not-allowed border border-pixel-blue transition-all duration-200 md:hidden" 
            id="prev-btn"
            aria-label="Ver apartaestudio anterior"
            aria-describedby="carousel-instructions"
          >
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-pixel-blue" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
            </svg>
          </button>
          
          <button 
            class="absolute right-2 top-1/2 z-10 -translate-y-1/2 bg-white rounded-lg p-3 shadow-lg hover:bg-gray-100 focus:outline-none disabled:opacity-30 disabled:cursor-not-allowed border border-pixel-blue transition-all duration-200 md:hidden" 
            id="next-btn"
            aria-label="Ver apartaestudio siguiente"
            aria-describedby="carousel-instructions"
          >
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-pixel-blue" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
            </svg>
          </button>
          
          <!-- Carrusel de slides -->
          <div 
            class="flex transition-transform duration-500 ease-in-out -mx-2" 
            id="carousel-slides"
            role="group"
            aria-label="Carrusel de apartaestudios"
            aria-live="polite"
          >
            {estudios.map((estudio, index) => (
              <article 
                class="w-full md:w-1/2 lg:w-1/3 flex-shrink-0 px-2 transition-opacity duration-300" 
                data-slide-index={index} 
                data-estudio-id={estudio.id}
                aria-labelledby={`estudio-${estudio.id}-title`}
              >
                <div class="bg-white rounded-lg overflow-hidden shadow-lg h-full flex flex-col transform transition duration-300 hover:-translate-y-2 hover:shadow-xl border-2 border-pixel-blue pixel-hover">
                  <div class="relative">
                    <img 
                      src={estudio.imagen} 
                      alt={`${estudio.nombre} - Vista principal del apartaestudio`}
                      class="w-full h-64 object-cover main-image cursor-pointer" 
                      data-estudio-id={estudio.id}
                      tabindex="0"
                      role="button"
                      aria-label={`Ver galer√≠a completa de ${estudio.nombre}`}
                    />
                    
                    <div class="absolute top-4 right-4 bg-white py-1 px-3 rounded-md shadow-md border border-pixel-blue">
                      <span class="font-medium text-sm" aria-label={`√Årea: ${estudio.metros}`}>{estudio.metros}</span>
                    </div>
                    
                    <!-- Bot√≥n para abrir galer√≠a -->
                    <button 
                      class="absolute bottom-4 right-4 bg-black bg-opacity-60 p-2 rounded-full text-white hover:bg-opacity-80 open-gallery-btn focus:bg-opacity-80 transition-all duration-200" 
                      data-estudio-id={estudio.id}
                      aria-label={`Abrir galer√≠a completa de ${estudio.nombre}`}
                      title={`Ver m√°s fotos de ${estudio.nombre}`}
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15" />
                      </svg>
                    </button>
                    
                    <!-- Miniaturas de galer√≠a -->
                    <div class="absolute bottom-4 left-4 flex space-x-1" role="group" aria-label={`Vista previa de im√°genes de ${estudio.nombre}`}>
                      <!-- Imagen principal como primera miniatura -->
                      <button 
                        class="w-8 h-8 rounded-md overflow-hidden border border-white cursor-pointer gallery-thumb hover:scale-110 focus:scale-110 transition-transform" 
                        data-estudio-id={estudio.id}
                        data-img-index={-1}
                        aria-label={`Ver imagen principal de ${estudio.nombre}`}
                        tabindex="0"
                      >
                        <img src={estudio.imagen} alt="" class="w-full h-full object-cover" />
                      </button>
                      
                      <!-- Im√°genes de la galer√≠a (m√°ximo 3 miniaturas adicionales) -->
                      {estudiosCompletos[estudio.id].galeria.slice(0, 3).map((img: string, imgIndex: number) => (
                        <button 
                          class="w-8 h-8 rounded-md overflow-hidden border border-white cursor-pointer gallery-thumb hover:scale-110 focus:scale-110 transition-transform" 
                          data-estudio-id={estudio.id}
                          data-img-index={imgIndex}
                          aria-label={`Ver imagen ${imgIndex + 2} de ${estudio.nombre}`}
                          tabindex="0"
                        >
                          <img src={img} alt="" class="w-full h-full object-cover" />
                        </button>
                      ))}
                    </div>
                  </div>
                  
                  <div class="p-4 flex-grow">
                    <h3 id={`estudio-${estudio.id}-title`} class="text-xl font-bold mb-2 text-pixel-blue">
                      {estudio.nombre}
                    </h3>
                    <p class="text-gray-600 mb-3">{estudio.descripcion}</p>
                    
                    <div class="mt-auto">
                      <div class="flex justify-between items-center">
                        <span class="text-xl font-bold text-pixel-blue" aria-label={`Precio desde ${estudio.precio}`}>
                          {estudio.precio}
                        </span>
                        <a 
                          href={`/estudio/${estudio.id}`} 
                          class="text-pixel-blue font-medium inline-flex items-center group ver-detalles-btn hover:underline focus:underline"
                          aria-describedby={`estudio-${estudio.id}-title`}
                        >
                          Ver detalles
                          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 ml-1 transform transition-transform group-hover:translate-x-1" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5 21 12m0 0-7.5 7.5M21 12H3" />
                          </svg>
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              </article>
            ))}
          </div>
        </div>
        
        <!-- Indicadores -->
        <div class="flex justify-center pb-8 space-x-2" id="carousel-indicators" role="group" aria-label="Indicadores de carrusel">
          {estudios.map((_, index) => (
            <button 
              class="w-4 h-4 bg-gray-200 focus:outline-none transition-colors duration-300 rounded-sm border border-pixel-blue hover:scale-110 focus:scale-110" 
              data-index={index}
              aria-label={`Ir a apartaestudio ${index + 1}`}
              role="tab"
              aria-selected={index === 0 ? 'true' : 'false'}
              tabindex={index === 0 ? 0 : -1}
            ></button>
          ))}
        </div>
      </div>
    </div>
    
    <!-- Caracter√≠sticas -->
    <div class="bg-white rounded-lg shadow-lg p-8 max-w-4xl mx-auto mt-16 border-2 border-pixel-blue">
      <h3 class="text-2xl font-bold mb-6 text-center text-pixel-blue">Caracter√≠sticas de nuestros espacios</h3>
      
      <div class="grid grid-cols-2 md:grid-cols-3 gap-6" role="list">
        {caracteristicas.map((item: { icono: ImageMetadata; texto: string }) => (
          <div class="flex items-start space-x-3" role="listitem">
            <div class="flex-shrink-0 p-1 rounded-md border border-pixel-blue" aria-hidden="true">
              <img 
                src={item.icono.src} 
                alt="" 
                class="w-8 h-8 object-contain"
              />
            </div>
            <div>
              <p class="font-medium">{item.texto}</p>
            </div>
          </div>
        ))}
      </div>
      
      <div class="mt-8 text-center">
        <a 
          href="#reservas" 
          class="btn bg-pixel-blue hover:bg-blue-600 text-white inline-flex items-center border border-blue-700 pixel-hover focus:ring-4 focus:ring-blue-300 transition-all duration-200"
          aria-describedby="reservas-cta-desc"
        >
          üëâ Solicita disponibilidad
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 ml-2" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5 21 12m0 0-7.5 7.5M21 12H3" />
          </svg>
        </a>
        <p id="reservas-cta-desc" class="sr-only">Ir a la secci√≥n de reservas para solicitar disponibilidad de apartaestudios</p>
      </div>
    </div>
    
    <!-- Importar el componente de lightbox compartido -->
    <LightboxModal id="espacios-lightbox" showDetailsButton={true} showReservaButton={true} />
  </div>
</section>

<script define:vars={{ lightboxData }}>
document.addEventListener('DOMContentLoaded', () => {
  console.log("=== ESPACIOS CARRUSEL CORREGIDO ===");
  
  // ===== HELPERS TYPE-SAFE PARA ASTRO 5.x =====
  const getAccessibilityManager = () => {
    return (typeof window !== 'undefined' && window.PAM) ? window.PAM : null;
  };
  
  const announceCarouselChange = (current, total, title = '') => {
    const pam = getAccessibilityManager();
    if (pam && typeof pam.announceCarouselChange === 'function') {
      pam.announceCarouselChange(current, total, title);
    }
  };
  
  const announceLightboxChange = (current, total, title = '') => {
    const pam = getAccessibilityManager();
    if (pam && typeof pam.announceLightboxChange === 'function') {
      pam.announceLightboxChange(current, total, title);
    }
  };
  
  const trapFocus = (container) => {
    const pam = getAccessibilityManager();
    if (pam && typeof pam.trapFocus === 'function') {
      pam.trapFocus(container);
    }
  };
  
  const releaseFocusTrap = () => {
    const pam = getAccessibilityManager();
    if (pam && typeof pam.releaseFocusTrap === 'function') {
      pam.releaseFocusTrap();
    }
  };
  
  // Funci√≥n para dispatch de eventos personalizado compatible con Astro 5.x
  const dispatchEstudioSeleccionado = (estudioId, estudioNombre) => {
    const event = new CustomEvent('estudioSeleccionado', {
      detail: { estudioId, estudioNombre },
      bubbles: true,
      cancelable: true
    });
    document.dispatchEvent(event);
  };
  
  // ===== VERIFICAR ELEMENTOS CR√çTICOS =====
  const container = document.getElementById('carousel-container');
  const slides = document.getElementById('carousel-slides');
  const prevBtn = document.getElementById('prev-btn');
  const nextBtn = document.getElementById('next-btn');
  const indicators = document.querySelectorAll('#carousel-indicators button');
  const lightboxModal = document.getElementById('espacios-lightbox');
  const slideElements = document.querySelectorAll('[data-slide-index]');
  
  console.log("Elementos encontrados:", {
    container: !!container,
    slides: !!slides,
    prevBtn: !!prevBtn,
    nextBtn: !!nextBtn,
    indicators: indicators.length,
    lightboxModal: !!lightboxModal,
    slideElements: slideElements.length,
    lightboxData: Object.keys(lightboxData || {})
  });

  if (!container || !slides || !prevBtn || !nextBtn) {
    console.error("‚ùå Elementos del carrusel no encontrados");
    return;
  }

  if (!lightboxModal) {
    console.error("‚ùå Modal lightbox no encontrado");
    return;
  }

  // ===== VARIABLES CARRUSEL =====
  let currentIndex = 0;
  let slidesPerView = window.innerWidth < 768 ? 1 : window.innerWidth < 1024 ? 2 : 3;
  const totalSlides = indicators.length;
  let isMobile = () => window.innerWidth < 768;

  // ===== FUNCIONES CARRUSEL =====
  function updateCarousel() {
    console.log("Actualizando carrusel:", { currentIndex, slidesPerView, totalSlides, isMobile: isMobile() });
    
    // Calcular el ancho del slide basado en el contenedor padre
    const containerWidth = slides.parentElement.clientWidth;
    const slideWidth = containerWidth / slidesPerView;
    
    // Aplicar transformaci√≥n
    slides.style.transform = `translateX(-${currentIndex * slideWidth}px)`;
    
    // En desktop, deshabilitar botones
    const isDesktop = !isMobile();
    
    // Actualizar botones - solo funcionales en m√≥vil
    if (isDesktop) {
      prevBtn.disabled = true;
      nextBtn.disabled = true;
      prevBtn.setAttribute('aria-hidden', 'true');
      nextBtn.setAttribute('aria-hidden', 'true');
    } else {
      prevBtn.disabled = currentIndex === 0;
      nextBtn.disabled = currentIndex >= totalSlides - slidesPerView;
      prevBtn.setAttribute('aria-hidden', 'false');
      nextBtn.setAttribute('aria-hidden', 'false');
    }
    
    // Actualizar ARIA states
    prevBtn.setAttribute('aria-disabled', String(isDesktop || currentIndex === 0));
    nextBtn.setAttribute('aria-disabled', String(isDesktop || currentIndex >= totalSlides - slidesPerView));
    
    // Actualizar indicadores
    indicators.forEach((indicator, index) => {
      const isActive = index === currentIndex;
      indicator.classList.toggle('bg-pixel-blue', isActive);
      indicator.classList.toggle('bg-gray-200', !isActive);
      indicator.setAttribute('aria-selected', String(isActive));
      indicator.setAttribute('tabindex', isActive ? '0' : '-1');
    });
    
    // Anunciar cambio a lectores de pantalla (solo en m√≥vil)
    if (!isDesktop && slideElements[currentIndex]) {
      const currentSlide = slideElements[currentIndex];
      const estudioNombre = currentSlide?.querySelector('h3')?.textContent || '';
      announceCarouselChange(currentIndex + 1, totalSlides, estudioNombre);
    }
  }

  // ===== EVENTOS CARRUSEL - SOLO EN M√ìVIL =====
  prevBtn.addEventListener('click', () => {
    if (!isMobile()) return; // Bloquear en desktop
    
    if (currentIndex > 0) {
      currentIndex--;
      updateCarousel();
    }
  });

  nextBtn.addEventListener('click', () => {
    if (!isMobile()) return; // Bloquear en desktop
    
    if (currentIndex < totalSlides - slidesPerView) {
      currentIndex++;
      updateCarousel();
    }
  });

  // Navegaci√≥n con teclado en indicadores (funciona en todas las resoluciones)
  indicators.forEach((indicator, index) => {
    indicator.addEventListener('click', () => {
      currentIndex = Math.min(index, totalSlides - slidesPerView);
      updateCarousel();
    });

    indicator.addEventListener('keydown', (e) => {
      let targetIndex = currentIndex;
      
      switch (e.key) {
        case 'ArrowLeft':
          e.preventDefault();
          targetIndex = Math.max(0, currentIndex - 1);
          break;
        case 'ArrowRight':
          e.preventDefault();
          targetIndex = Math.min(totalSlides - slidesPerView, currentIndex + 1);
          break;
        case 'Home':
          e.preventDefault();
          targetIndex = 0;
          break;
        case 'End':
          e.preventDefault();
          targetIndex = totalSlides - slidesPerView;
          break;
      }
      
      if (targetIndex !== currentIndex) {
        currentIndex = targetIndex;
        updateCarousel();
        indicators[currentIndex].focus();
      }
    });
  });

  // Responsive handling mejorado
  window.addEventListener('resize', () => {
    const newSlidesPerView = window.innerWidth < 768 ? 1 : window.innerWidth < 1024 ? 2 : 3;
    if (newSlidesPerView !== slidesPerView) {
      slidesPerView = newSlidesPerView;
      currentIndex = Math.min(currentIndex, Math.max(0, totalSlides - slidesPerView));
      updateCarousel();
    }
  });

  // Inicializar carrusel
  updateCarousel();

  // ===== LIGHTBOX COMPATIBLE CON ASTRO 5.x =====
  const lightboxImage = lightboxModal.querySelector('.lightbox-image');
  const lightboxTitle = lightboxModal.querySelector('.lightbox-title');
  const lightboxThumbnails = lightboxModal.querySelector('.lightbox-thumbnails');
  const lightboxClose = lightboxModal.querySelector('.lightbox-close');
  const lightboxPrev = lightboxModal.querySelector('.lightbox-prev');
  const lightboxNext = lightboxModal.querySelector('.lightbox-next');
  const lightboxDetailsLink = lightboxModal.querySelector('.lightbox-details-link');
  const lightboxReservaLink = lightboxModal.querySelector('.lightbox-reserva-link');
  const lightboxCurrent = lightboxModal.querySelector('.lightbox-current');
  const lightboxTotal = lightboxModal.querySelector('.lightbox-total');

  let currentEstudioId = '';
  let currentImageIndex = 0;
  let currentImages = [];

  function buildImageArray(estudioData) {
    const images = [];
    if (estudioData.imagenPrincipal) {
      images.push({
        src: estudioData.imagenPrincipal,
        alt: `${estudioData.nombre} - Imagen principal`
      });
    }
    if (estudioData.imagenes && Array.isArray(estudioData.imagenes)) {
      estudioData.imagenes.forEach((src, index) => {
        images.push({
          src: src,
          alt: `${estudioData.nombre} - Imagen ${index + 1}`
        });
      });
    }
    return images;
  }

  function updateLightboxImage() {
    if (!lightboxImage || currentImages.length === 0) return;
    
    const currentImage = currentImages[currentImageIndex];
    lightboxImage.style.opacity = '0.7';
    
    setTimeout(() => {
      lightboxImage.src = currentImage.src;
      lightboxImage.alt = currentImage.alt;
      lightboxImage.style.opacity = '1';
    }, 150);

    // Update counter
    if (lightboxCurrent) lightboxCurrent.textContent = currentImageIndex + 1;
    if (lightboxTotal) lightboxTotal.textContent = currentImages.length;

    // Update navigation
    if (lightboxPrev) {
      lightboxPrev.disabled = currentImageIndex === 0;
      lightboxPrev.setAttribute('aria-disabled', String(currentImageIndex === 0));
      lightboxPrev.style.opacity = currentImageIndex === 0 ? '0.5' : '1';
    }
    if (lightboxNext) {
      lightboxNext.disabled = currentImageIndex === currentImages.length - 1;
      lightboxNext.setAttribute('aria-disabled', String(currentImageIndex === currentImages.length - 1));
      lightboxNext.style.opacity = currentImageIndex === currentImages.length - 1 ? '0.5' : '1';
    }

    updateLightboxThumbnails();

    // Anunciar cambio
    const estudioData = lightboxData[currentEstudioId];
    announceLightboxChange(currentImageIndex + 1, currentImages.length, estudioData?.nombre);
  }

  function updateLightboxThumbnails() {
    if (!lightboxThumbnails) return;

    lightboxThumbnails.innerHTML = '';
    currentImages.forEach((image, index) => {
      const thumb = document.createElement('button');
      thumb.className = `cursor-pointer rounded-md overflow-hidden transition-all duration-200 ${
        index === currentImageIndex 
          ? 'ring-2 ring-white ring-offset-2 ring-offset-black opacity-100' 
          : 'opacity-70 hover:opacity-90'
      }`;
      
      thumb.setAttribute('aria-label', `Ver ${image.alt}`);
      thumb.setAttribute('tabindex', '0');

      thumb.innerHTML = `<img src="${image.src}" alt="" class="w-16 h-16 object-cover" loading="lazy" />`;

      thumb.addEventListener('click', () => {
        currentImageIndex = index;
        updateLightboxImage();
      });

      thumb.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          currentImageIndex = index;
          updateLightboxImage();
        }
      });

      lightboxThumbnails.appendChild(thumb);
    });
  }

  function openLightbox(estudioId, imageIndex = 0) {
    console.log("üéØ Abriendo lightbox:", { estudioId, imageIndex });
    
    const estudioData = lightboxData[estudioId];
    if (!estudioData) {
      console.error('Estudio no encontrado:', estudioId);
      return;
    }

    currentEstudioId = estudioId;
    currentImages = buildImageArray(estudioData);
    currentImageIndex = Math.max(0, Math.min(imageIndex, currentImages.length - 1));

    // Update title
    if (lightboxTitle) {
      lightboxTitle.textContent = estudioData.nombre;
    }

    // Update links
    if (lightboxDetailsLink) {
      lightboxDetailsLink.href = `/estudio/${estudioId}`;
    }

    if (lightboxReservaLink) {
      lightboxReservaLink.href = '#reservas';
    }

    updateLightboxImage();

    // Show modal with accessibility
    lightboxModal.classList.remove('hidden');
    lightboxModal.classList.add('flex');
    document.body.style.overflow = 'hidden';

    // Focus management
    trapFocus(lightboxModal);
    
    // Fallback focus si no hay PAM disponible
    if (!getAccessibilityManager()) {
      setTimeout(() => {
        lightboxClose?.focus();
      }, 100);
    }

    console.log("‚úÖ Lightbox abierto exitosamente");
  }

  function closeLightbox() {
    lightboxModal.classList.add('hidden');
    lightboxModal.classList.remove('flex');
    document.body.style.overflow = '';
    
    // Release focus trap
    releaseFocusTrap();
    
    console.log("Lightbox cerrado");
  }

  // ===== EVENTOS LIGHTBOX =====
  
  // Cerrar
  if (lightboxClose) {
    lightboxClose.addEventListener('click', closeLightbox);
  }

  // Navegaci√≥n
  if (lightboxPrev) {
    lightboxPrev.addEventListener('click', () => {
      if (currentImageIndex > 0) {
        currentImageIndex--;
        updateLightboxImage();
      }
    });
  }

  if (lightboxNext) {
    lightboxNext.addEventListener('click', () => {
      if (currentImageIndex < currentImages.length - 1) {
        currentImageIndex++;
        updateLightboxImage();
      }
    });
  }

  // Click fuera del modal
  lightboxModal.addEventListener('click', (e) => {
    if (e.target === lightboxModal) {
      closeLightbox();
    }
  });

  // Teclado
  document.addEventListener('keydown', (e) => {
    if (!lightboxModal.classList.contains('hidden')) {
      if (e.key === 'Escape') {
        closeLightbox();
      } else if (e.key === 'ArrowLeft') {
        if (currentImageIndex > 0) {
          currentImageIndex--;
          updateLightboxImage();
        }
      } else if (e.key === 'ArrowRight') {
        if (currentImageIndex < currentImages.length - 1) {
          currentImageIndex++;
          updateLightboxImage();
        }
      }
    }
  });

  // RESERVAR AHORA - Compatible con Astro 5.x
  if (lightboxReservaLink) {
    lightboxReservaLink.addEventListener('click', (e) => {
      e.preventDefault();
      console.log("üéØ Reservar clicked para:", currentEstudioId);
      
      // Cerrar lightbox
      closeLightbox();
      
      // Enviar evento (compatible con Astro 5.x)
      setTimeout(() => {
        const estudioData = lightboxData[currentEstudioId];
        dispatchEstudioSeleccionado(
          currentEstudioId,
          estudioData ? estudioData.nombre : 'Estudio seleccionado'
        );
        
        console.log("‚úÖ Evento estudioSeleccionado enviado:", {
          estudioId: currentEstudioId,
          estudioNombre: estudioData?.nombre
        });
      }, 200);

      // Scroll a reservas
      setTimeout(() => {
        const reservasSection = document.querySelector('#reservas');
        if (reservasSection) {
          reservasSection.scrollIntoView({ 
            behavior: 'smooth',
            block: 'start'
          });
          console.log("‚úÖ Scroll a reservas completado");
        }
      }, 400);
    });
  }

  // ===== EVENTOS PARA ABRIR LIGHTBOX =====
  
  // Bot√≥n galer√≠a
  document.querySelectorAll('.open-gallery-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      const estudioId = btn.getAttribute('data-estudio-id');
      if (estudioId) {
        console.log("Click en gallery btn:", estudioId);
        openLightbox(estudioId, 0);
      }
    });
  });

  // Thumbnails
  document.querySelectorAll('.gallery-thumb').forEach(thumb => {
    thumb.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      const estudioId = thumb.getAttribute('data-estudio-id');
      const imgIndex = parseInt(thumb.getAttribute('data-img-index') || '0');
      if (estudioId) {
        const lightboxIndex = imgIndex === -1 ? 0 : imgIndex + 1;
        console.log("Click en thumbnail:", { estudioId, imgIndex, lightboxIndex });
        openLightbox(estudioId, lightboxIndex);
      }
    });

    // Keyboard support for thumbnails
    thumb.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        thumb.click();
      }
    });
  });

  // Imagen principal
  document.querySelectorAll('.main-image').forEach(img => {
    img.addEventListener('click', (e) => {
      if (e.target !== img) return;
      const estudioId = img.getAttribute('data-estudio-id');
      if (estudioId) {
        console.log("Click en main image:", estudioId);
        openLightbox(estudioId, 0);
      }
    });

    // Keyboard support for main image
    img.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        img.click();
      }
    });
  });

  console.log("‚úÖ Espacios con carrusel corregido inicializado");
  console.log("üì± Navegaci√≥n responsive activada - Botones solo en m√≥vil");
  
  // Debug
  window.espaciosDebug = {
    openLightbox,
    closeLightbox,
    lightboxData,
    currentEstudioId: () => currentEstudioId,
    testLightbox: (estudioId) => openLightbox(estudioId, 0),
    isMobile: isMobile,
    updateCarousel,
    currentIndex: () => currentIndex
  };
});
</script>

<style>
  /* Screen reader only utility */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  /* Enhanced focus styles for keyboard navigation */
  .keyboard-navigation button:focus,
  .keyboard-navigation [role="button"]:focus {
    outline: 2px solid #ffd700;
    outline-offset: 2px;
    box-shadow: 0 0 0 4px rgba(255, 215, 0, 0.3);
  }

  /* Gallery thumbnail focus */
  .keyboard-navigation .gallery-thumb:focus {
    transform: scale(1.15);
    z-index: 10;
    position: relative;
  }

  /* Carousel indicator focus */
  .keyboard-navigation [data-index]:focus {
    transform: scale(1.3);
    z-index: 10;
  }

  /* Lightbox focus styles */
  .lightbox-modal.flex .keyboard-navigation button:focus {
    box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.8);
  }

  /* NUEVA ESTRUCTURA DE RESPONSIVE NAVIGATION */
  
  /* Botones de navegaci√≥n solo en m√≥vil */
  @media (min-width: 768px) {
    #prev-btn,
    #next-btn {
      display: none !important;
    }
  }

  /* Mejorar √°rea de toque en m√≥vil */
  #prev-btn,
  #next-btn {
    min-width: 44px;
    min-height: 44px;
    -webkit-tap-highlight-color: transparent;
  }

  /* Carrusel responsivo sin cortes */
  #carousel-slides {
    will-change: transform;
  }

  /* Espaciado negativo para compensar padding */
  #carousel-slides.-mx-2 {
    margin-left: -0.5rem;
    margin-right: -0.5rem;
  }

  /* Improved hover effects for accessibility */
  @media (hover: hover) {
    .gallery-thumb:hover,
    .open-gallery-btn:hover {
      transform: scale(1.05);
    }
    
    .main-image:hover {
      opacity: 0.9;
    }

    /* Hover en botones de navegaci√≥n solo en m√≥vil */
    @media (max-width: 767px) {
      #prev-btn:hover,
      #next-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
    }
  }

  /* High contrast mode support */
  @media (prefers-contrast: high) {
    .gallery-thumb,
    .open-gallery-btn,
    #prev-btn,
    #next-btn {
      border: 2px solid;
    }
    
    .carousel-indicator {
      border: 2px solid;
    }
  }

  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    .gallery-thumb,
    .open-gallery-btn,
    .main-image,
    #carousel-slides,
    #prev-btn,
    #next-btn {
      transition: none !important;
    }
    
    .hover\:scale-110:hover,
    .focus\:scale-110:focus {
      transform: none !important;
    }
  }

  /* Asegurar que el carrusel no se desborde */
  #carousel-container {
    contain: layout;
  }

  /* Prevenir scroll horizontal no deseado */
  .bg-pixel-blue {
    overflow-x: hidden;
  }
</style>