---
 // IMPORTAR I18N
 import { getLanguageFromUrl, t, setCurrentLanguage } from '../i18n/utils/translator';

 // Detectar idioma actual
 const currentLang = getLanguageFromUrl(Astro.url.pathname);
 setCurrentLanguage(currentLang);
---

<section id="reservas" class="py-16 bg-gray-50">
  <div class="container">
    <div class="max-w-5xl mx-auto">
      <!-- Header -->
      <div class="text-center mb-12">
        <span class="inline-block text-pixel-brown font-semibold text-sm uppercase tracking-wider mb-2">
          {t('reservas.badge')}
        </span>
        <h2 class="text-3xl md:text-5xl font-normal text-gray-900 mb-4">
          {t('reservas.title')}
        </h2>
        <p class="text-lg text-gray-600 max-w-2xl mx-auto">
          {t('reservas.description')}
        </p>
      </div>

      <!-- Card -->
      <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-6 md:p-8">
        <!-- Contenedor de mensajes globales -->
        <div id="message-container" class=""></div>

        <form id="reservaForm" class="space-y-6" data-bypass-intercept="true">
          <!-- Honeypot anti-spam (oculto) -->
          <input 
            type="text" 
            id="website_url" 
            name="website_url" 
            class="hidden" 
            tabindex="-1" 
            autocomplete="off" 
          />

          <!-- Nombre y correo -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="nombre" class="block text-sm font-medium text-gray-700 mb-1">
                {t('reservas.form.nombre_label')}
              </label>
              <input 
                type="text" 
                id="nombre" 
                name="nombre" 
                class="w-full px-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-pixel-brown focus:border-transparent bg-white" 
                placeholder={t('reservas.form.nombre_placeholder')}
                autocomplete="name"
                required
              />
              <div id="nombre-error" class="hidden text-red-600 text-sm mt-1"></div>
            </div>
            
            <div>
              <label for="email" class="block text-sm font-medium text-gray-700 mb-1">
                {t('reservas.form.email_label')}
              </label>
              <input 
                type="email" 
                id="email" 
                name="email" 
                class="w-full px-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-pixel-brown focus:border-transparent bg-white" 
                placeholder={t('reservas.form.email_placeholder')}
                autocomplete="email"
                required
              />
              <div id="email-error" class="hidden text-red-600 text-sm mt-1"></div>
            </div>
          </div>

          <!-- 1. Elige tu tipo de estad√≠a -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              {t('reservas.form.tipo_estadia_label')}
            </label>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <label class="flex items-center gap-2 rounded-md border border-gray-300 px-4 py-3 bg-white cursor-pointer hover:border-pixel-brown">
                <input 
                  type="radio" 
                  name="tipo_estadia"
                  value="estadia-corta" 
                  class="w-4 h-4 text-pixel-brown focus:ring-pixel-brown border-gray-300"
                />
                <span class="text-sm text-gray-800">
                  {t('reservas.form.tipo_estadia_opcion_estadia_corta')}
                </span>
              </label>

              <label class="flex items-center gap-2 rounded-md border border-gray-300 px-4 py-3 bg-white cursor-pointer hover:border-pixel-brown">
                <input 
                  type="radio" 
                  name="tipo_estadia"
                  value="coliving" 
                  class="w-4 h-4 text-pixel-brown focus:ring-pixel-brown border-gray-300"
                />
                <span class="text-sm text-gray-800">
                  {t('reservas.form.tipo_estadia_opcion_coliving')}
                </span>
              </label>
            </div>
          </div>

          <!-- Campo NOCHES (solo estad√≠a corta) -->
          <div id="campo-noches" class="hidden">
            <label for="noches" class="block text-sm font-medium text-gray-700 mb-1">
              {t('reservas.form.noches_label')}
            </label>
            <input 
              type="number"
              id="noches"
              name="noches"
              min="3"
              max="29"
              class="w-full px-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-pixel-brown focus:border-transparent bg-white"
              placeholder={t('reservas.form.noches_placeholder')}
            />
            <p class="text-xs text-gray-500 mt-1">
              {t('reservas.form.noches_helper')}
            </p>
            <div id="noches-error" class="hidden text-red-600 text-sm mt-1"></div>
          </div>

          <!-- Tel√©fono y duraci√≥n (meses para coliving) -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="telefono" class="block text-sm font-medium text-gray-700 mb-1">
                {t('reservas.form.telefono_label')}
              </label>
              <input 
                type="tel" 
                id="telefono" 
                name="telefono" 
                class="w-full px-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-pixel-brown focus:border-transparent bg-white"
                placeholder={t('reservas.form.telefono_placeholder')}
                autocomplete="tel"
                required
              />
              <div id="telefono-error" class="hidden text-red-600 text-sm mt-1"></div>
            </div>

            <div>
              <label for="duracion" class="block text-sm font-medium text-gray-700 mb-1">
                {t('reservas.form.duracion_label')}
              </label>
              <select 
                id="duracion" 
                name="duracion" 
                class="w-full px-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-pixel-brown focus:border-transparent bg-white"
              >
                <option value="">{t('reservas.form.duracion_opcion_placeholder')}</option>
                <option value="1">{t('reservas.form.duracion_opcion_1')}</option>
                <option value="3">{t('reservas.form.duracion_opcion_3')}</option>
                <option value="6">{t('reservas.form.duracion_opcion_6')}</option>
                <option value="12">{t('reservas.form.duracion_opcion_12')}</option>
              </select>
              <p class="text-xs text-gray-500 mt-1">
                {t('reservas.form.duracion_helper')}
              </p>
              <div id="duracion-error" class="hidden text-red-600 text-sm mt-1"></div>
            </div>
          </div>

          <!-- Fecha y personas -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="fecha" class="block text-sm font-medium text-gray-700 mb-1">
                {t('reservas.form.fecha_label')}
              </label>
              <input 
                type="date" 
                id="fecha" 
                name="fecha" 
                class="w-full px-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-pixel-brown focus:border-transparent bg-white"
              />
              <p class="text-xs text-gray-500 mt-1">
                {t('reservas.form.fecha_helper')}
              </p>
            </div>

            <div>
              <label for="personas" class="block text-sm font-medium text-gray-700 mb-1">
                {t('reservas.form.personas_label')}
              </label>
              <select 
                id="personas" 
                name="personas" 
                class="w-full px-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-pixel-brown focus:border-transparent bg-white"
              >
                <option value="">{t('reservas.form.personas_opcion_placeholder')}</option>
                <option value="1">{t('reservas.form.personas_opcion_1')}</option>
                <option value="2">{t('reservas.form.personas_opcion_2')}</option>
              </select>
              <div id="personas-error" class="hidden text-red-600 text-sm mt-1"></div>
            </div>
          </div>

          <!-- ¬øC√≥mo nos conociste? -->
          <div>
            <label for="como_conociste" class="block text-sm font-medium text-gray-700 mb-1">
              {t('reservas.form.como_conociste_label')}
            </label>
            <select 
              id="como_conociste" 
              name="como_conociste" 
              class="w-full px-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-pixel-brown focus:border-transparent bg-white"
            >
              <option value="">{t('reservas.form.como_conociste_opcion_placeholder')}</option>
              <option value="instagram">{t('reservas.form.como_conociste_opcion_instagram')}</option>
              <option value="google">{t('reservas.form.como_conociste_opcion_google')}</option>
              <option value="referido">{t('reservas.form.como_conociste_opcion_referido')}</option>
              <option value="otro">{t('reservas.form.como_conociste_opcion_otro')}</option>
            </select>
          </div>

          <!-- Mensaje -->
          <div>
            <label for="mensaje" class="block text-sm font-medium text-gray-700 mb-1">
              {t('reservas.form.mensaje_label')}
            </label>
            <textarea
              id="mensaje"
              name="mensaje"
              rows="4"
              class="w-full px-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-pixel-brown focus:border-transparent bg-white"
              placeholder={t('reservas.form.mensaje_placeholder')}
            ></textarea>
            <p id="contador-caracteres" class="mt-1 text-xs text-gray-500 text-right">
              {t('reservas.form.mensaje_contador_inicial')}
            </p>
          </div>

          <!-- Acepta pol√≠tica -->
          <div class="flex items-start gap-2">
            <input 
              type="checkbox" 
              id="acepta_politica" 
              name="acepta_politica" 
              class="mt-1 w-4 h-4 text-pixel-brown border-gray-300 rounded"
              required
            />
            <label for="acepta_politica" class="text-sm text-gray-700">
              {t('reservas.form.acepta_politica_label')}
            </label>
          </div>

          <!-- Mensaje de error global -->
          <div id="form-error" class="hidden text-red-600 text-sm"></div>

          <!-- Bot√≥n -->
          <div class="pt-4">
            <button 
              type="submit"
              id="submitBtn"
              class="w-full md:w-auto inline-flex items-center justify-center px-8 py-3 rounded-lg bg-pixel-brown text-white font-semibold hover:bg-pixel-brown/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pixel-brown transition"
            >
              {t('reservas.form.boton_enviar')}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>

<script is:inline>
// @ts-nocheck

(function () {
  // ===== CONFIG =====
  const CONFIG = {
    EMAIL_DESTINO: 'comercialpixel98a@gmail.com',
    WHATSAPP_NUMERO: '573195895858',
    MAX_CARACTERES_MENSAJE: 500,
    TIEMPO_MINIMO_ENVIO: 3000 // 3 segundos anti-bot
  };

  const tiempoInicio = Date.now();

  const form = document.getElementById('reservaForm');
  if (!form) return;

  const submitBtn = document.getElementById('submitBtn');
  const messageContainer = document.getElementById('message-container');
  const formError = document.getElementById('form-error');

  const campoNombre = document.getElementById('nombre');
  const campoEmail = document.getElementById('email');
  const campoTelefono = document.getElementById('telefono');
  const campoDuracion = document.getElementById('duracion');
  const campoFecha = document.getElementById('fecha');
  const campoPersonas = document.getElementById('personas');
  const campoComoConociste = document.getElementById('como_conociste');
  const campoMensaje = document.getElementById('mensaje');
  const campoAceptaPolitica = document.getElementById('acepta_politica');
  const campoHoneypot = document.getElementById('website_url');

  const contadorCaracteres = document.getElementById('contador-caracteres');

  const radiosTipo = form.querySelectorAll('input[name="tipo_estadia"]');
  const campoNochesContainer = document.getElementById('campo-noches');
  const campoDuracionContainer = document.getElementById('campo-duracion');
  const inputNoches = document.getElementById('noches');

  const errores = {
    nombre: document.getElementById('nombre-error'),
    email: document.getElementById('email-error'),
    telefono: document.getElementById('telefono-error'),
    duracion: document.getElementById('duracion-error'),
    fecha: document.getElementById('fecha-error'),
    personas: document.getElementById('personas-error'),
    noches: document.getElementById('noches-error')
  };

  function mostrarMensaje(tipo, texto) {
    if (!messageContainer) return;
    let color = '';
    if (tipo === 'success') color = 'bg-green-50 text-green-800 border-green-200';
    else if (tipo === 'error') color = 'bg-red-50 text-red-800 border-red-200';
    else color = 'bg-blue-50 text-blue-800 border-blue-200';

    messageContainer.className = 'mt-4 p-3 rounded-md border text-sm ' + color;
    messageContainer.textContent = texto;
  }

  function limpiarMensaje() {
    if (!messageContainer) return;
    messageContainer.textContent = '';
    messageContainer.className = '';
  }

  function limpiarErrores() {
    if (formError) {
      formError.textContent = '';
      formError.classList.add('hidden');
    }
    Object.keys(errores).forEach(function (k) {
      const el = errores[k];
      if (el) {
        el.textContent = '';
        el.classList.add('hidden');
      }
    });
  }

  function marcarError(campoId, mensaje) {
    const el = errores[campoId];
    if (el) {
      el.textContent = mensaje;
      el.classList.remove('hidden');
    }
  }

  function validarEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  }

  function getTipoEstadia() {
    let value = '';
    radiosTipo.forEach(function (r) {
      if (r.checked) value = r.value;
    });
    return value;
  }

  function actualizarVisibilidad() {
    const tipo = getTipoEstadia();

    // Noches (d√≠as) para estad√≠a corta
    if (campoNochesContainer && inputNoches) {
      if (tipo === 'estadia-corta') {
        campoNochesContainer.classList.remove('hidden');
      } else {
        campoNochesContainer.classList.add('hidden');
        inputNoches.value = '';
        const nochesError = errores.noches;
        if (nochesError) {
          nochesError.textContent = '';
          nochesError.classList.add('hidden');
        }
      }
    }

    // Meses (duraci√≥n) para coliving
    if (campoDuracionContainer) {
      if (tipo === 'estadia-corta') {
        campoDuracionContainer.classList.add('hidden');
      } else {
        campoDuracionContainer.classList.remove('hidden');
      }
    }
  }

  radiosTipo.forEach(function (r) {
    r.addEventListener('change', actualizarVisibilidad);
  });

  // Estado inicial: mostramos duraci√≥n (coliving) y ocultamos noches
  actualizarVisibilidad();

  // Contador de caracteres
  if (campoMensaje && contadorCaracteres) {
    campoMensaje.addEventListener('input', function () {
      const len = campoMensaje.value.length;
      const max = CONFIG.MAX_CARACTERES_MENSAJE;
      contadorCaracteres.textContent = `${len}/${max} caracteres`;

      contadorCaracteres.classList.remove('text-yellow-600', 'text-red-600', 'text-gray-500');
      if (len > max) {
        contadorCaracteres.classList.add('text-red-600');
      } else if (len > max * 0.9) {
        contadorCaracteres.classList.add('text-yellow-600');
      } else {
        contadorCaracteres.classList.add('text-gray-500');
      }
    });
  }

  // Anti-spam: patrones b√°sicos + tiempo m√≠nimo + caracteres raros en email
  function esSpam(datos) {
    const texto = (datos.nombre + ' ' + datos.email + ' ' + datos.mensaje).toLowerCase();
    const patrones = [
      /\b(viagra|cialis|casino|loan|credit|bitcoin|crypto)\b/i,
      /\b(click here|visit now|buy now|limited time)\b/i,
      /http[s]?:\/\//i
    ];
    const emailInvalido = /[^\w\s@.-]/.test(datos.email);
    const tiempo = Date.now() - tiempoInicio;

    if (tiempo < CONFIG.TIEMPO_MINIMO_ENVIO) return true;
    if (emailInvalido) return true;
    if (patrones.some(function (p) { return p.test(texto); })) return true;

    return false;
  }

  function crearMensajeWhatsApp(datos) {
    return (
`üè† *SOLICITUD RESERVA PIXEL LIVING*

üë§ *DATOS PERSONALES:*
- Nombre: ${datos.nombre}
- Email: ${datos.email}
- Tel√©fono: ${datos.telefono}

üìÖ *DETALLES DE LA RESERVA:*
- Tipo de estad√≠a: ${datos.tipo_estadia}
- Noches (si aplica): ${datos.noches}
- Duraci√≥n (coliving): ${datos.duracion}
- Fecha de ingreso: ${datos.fecha || 'Por coordinar'}
- N√∫mero de personas: ${datos.personas}
- Conoci√≥ Pixel por: ${datos.como_conociste || 'No especificado'}

üí¨ *MENSAJE ADICIONAL:*
${datos.mensaje || 'Ninguno'}

---
‚è∞ ${new Date().toLocaleString('es-CO')}
üåê pixelliving.co`
    );
  }

  async function enviarFormSubmit(datos) {
    const formData = new FormData();
    formData.append('Nombre_Completo', datos.nombre);
    formData.append('Email_Contacto', datos.email);
    formData.append('Tel√©fono', datos.telefono);
    formData.append('Tipo_de_Estad√≠a', datos.tipo_estadia);
    formData.append('Noches', datos.noches);
    formData.append('Duraci√≥n_Solicitada', datos.duracion);
    formData.append('Fecha_de_Ingreso', datos.fecha || 'Por coordinar');
    formData.append('N√∫mero_de_Personas', datos.personas);
    formData.append('Conoci√≥_Pixel_por', datos.como_conociste || 'No especificado');
    formData.append('Mensaje_Adicional', datos.mensaje || 'Ninguno');
    formData.append('Fecha_Env√≠o', new Date().toLocaleString('es-CO'));
    formData.append('Origen_Formulario', 'Formulario_Reservas_Principal');

    formData.append('_subject', `üè† Nueva Reserva Pixel Living - ${datos.nombre}`);
    formData.append('_template', 'table');
    formData.append('_captcha', 'false');
    formData.append('_next', 'https://pixelliving.co/gracias');

    const resp = await fetch(`https://formsubmit.co/${CONFIG.EMAIL_DESTINO}`, {
      method: 'POST',
      body: formData
    });

    if (!resp.ok) {
      throw new Error('Error al enviar el formulario');
    }
  }

  form.addEventListener('submit', async function (e) {
    e.preventDefault();
    limpiarMensaje();
    limpiarErrores();

    if (!submitBtn) return;

    const nombre = campoNombre ? campoNombre.value.trim() : '';
    const email = campoEmail ? campoEmail.value.trim() : '';
    const telefono = campoTelefono ? campoTelefono.value.trim() : '';
    const duracion = campoDuracion ? campoDuracion.value : '';
    const fecha = campoFecha ? campoFecha.value : '';
    const personas = campoPersonas ? campoPersonas.value : '';
    const comoConociste = campoComoConociste ? campoComoConociste.value : '';
    const mensaje = campoMensaje ? campoMensaje.value.trim() : '';
    const tipoEstadia = getTipoEstadia();
    const noches = inputNoches ? inputNoches.value.trim() : '';
    const aceptaPolitica = campoAceptaPolitica && campoAceptaPolitica.checked;
    const honeypotValue = campoHoneypot ? campoHoneypot.value.trim() : '';

    // Honeypot: si viene con valor, hacemos como que todo ok pero no enviamos nada
    if (honeypotValue) {
      mostrarMensaje('success', 'Solicitud enviada. Te contactaremos pronto.');
      form.reset();
      actualizarVisibilidad();
      return;
    }

    let valido = true;

    if (!nombre) {
      marcarError('nombre', 'Por favor ingresa tu nombre.');
      valido = false;
    }
    if (!email || !validarEmail(email)) {
      marcarError('email', 'Ingresa un correo electr√≥nico v√°lido.');
      valido = false;
    }
    if (!telefono) {
      marcarError('telefono', 'Ingresa un n√∫mero de tel√©fono o WhatsApp.');
      valido = false;
    }

    if (!tipoEstadia) {
      if (formError) {
        formError.textContent = 'Por favor elige tu tipo de estad√≠a.';
        formError.classList.remove('hidden');
      }
      valido = false;
    }

    if (tipoEstadia === 'estadia-corta') {
      const n = parseInt(noches, 10);
      if (!noches || isNaN(n) || n < 3 || n > 29) {
        marcarError('noches', 'Ingresa entre 3 y 29 noches para estad√≠a corta.');
        valido = false;
      }
    }

    if (tipoEstadia === 'coliving') {
      if (!duracion) {
        marcarError('duracion', 'Selecciona una duraci√≥n en meses para coliving.');
        valido = false;
      }
    }

    if (!personas) {
      marcarError('personas', 'Selecciona cu√°ntas personas se hospedar√°n.');
      valido = false;
    }

    if (!aceptaPolitica) {
      if (formError) {
        formError.textContent = 'Debes aceptar la pol√≠tica de privacidad.';
        formError.classList.remove('hidden');
      }
      valido = false;
    }

    if (!valido) return;

    const datos = {
      nombre,
      email,
      telefono,
      duracion: tipoEstadia === 'coliving' ? (duracion || 'No informado') : 'No aplica',
      fecha,
      personas,
      como_conociste: comoConociste,
      mensaje,
      tipo_estadia: tipoEstadia || 'No especificado',
      noches: tipoEstadia === 'estadia-corta' ? (noches || 'No informado') : 'No aplica'
    };

    // Anti-spam avanzado
    if (esSpam(datos)) {
      // Hacemos como si todo ok, pero no enviamos nada real
      mostrarMensaje('success', 'Solicitud enviada. Te contactaremos pronto.');
      form.reset();
      actualizarVisibilidad();
      return;
    }

    try {
      submitBtn.disabled = true;
      submitBtn.textContent = 'Enviando...';
      mostrarMensaje('loading', 'Procesando tu solicitud...');

      await enviarFormSubmit(datos);

      mostrarMensaje('success', '¬°Email enviado exitosamente! Tambi√©n puedes continuar por WhatsApp.');

      const mensajeWhatsApp = crearMensajeWhatsApp(datos);
      const urlWhatsApp = `https://wa.me/${CONFIG.WHATSAPP_NUMERO}?text=${encodeURIComponent(mensajeWhatsApp)}`;
      window.open(urlWhatsApp, '_blank');

      form.reset();
      actualizarVisibilidad();
    } catch (err) {
      console.error(err);
      mostrarMensaje('error', 'Hubo un error al enviar tu solicitud. Intenta nuevamente o escr√≠benos por WhatsApp.');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Enviar solicitud de reserva';
    }
  });
})();
</script>
